"""
âƒ `{i}Ù„ÙˆÙƒ`
    **âŒ”âˆ®Ù„Ù€ Ø¹Ø±Ø¶ Ø§Ø®Ø± Ø£Ø³Ø·Ø± Ù…Ù† Ø¹Ù…Ù„ÙŠØ© Ø§Ù„ØªÙ†ØµÙŠØ¨ ÙˆØ¹Ø±Ø¶ Ø³Ø¬Ù„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª**
    
âƒ `{i}Ø§Ø¹Ø§Ø¯Ø© ØªØ´ØºÙŠÙ„`
    **âŒ”âˆ®Ù„Ù€ Ø§Ø¹Ø§Ø¯Ø© ØªØ´ØºÙŠÙ„ Ø³ÙˆØ±Ø³ ÙŠÙ€Ù€Ù€Ù…Ù†Ø«ÙˆÙ†** ( Ø§Ù„Ø§ÙØ¶Ù„ ØªØ³ØªØ®Ø¯Ù…Ù‡ ÙÙŠ Ù…Ø¬Ù…ÙˆØ¹Ø© Ø§Ù„Ø³Ø¬Ù„ )
    
âƒ `{i}ØªØ­Ø¯ÙŠØ«`
    **âŒ”âˆ®Ù„Ù€ ØªØ­Ø¯ÙŠØ« Ø³ÙˆØ±Ø³ ÙŠÙ€Ù€Ù€Ù…Ù†Ø«ÙˆÙ† Ø§Ø°Ø§ ÙƒØ§Ù† Ù‡Ù†Ø§Ù„Ùƒ ØªØ­Ø¯ÙŠØ« Ø¬Ø¯ÙŠØ¯ ÙˆÙ„Ù…Ø¹Ø±ÙØ© Ø§Ù„ØªØ­Ø¯ÙŠØ«Ø§Øª ØªØ§Ø¨Ø¹** @YamenThon
"""


import os
import sys
import time
import asyncio
from yamenthon.helper.git import repo
from yamenthon.helper import check_update, bash, get_client
from .. import jmdB, jmthon_cmd


@jmthon_cmd(pattern="Ù„ÙˆÙƒ( (.*)|$)")
async def logs_jmthon(event):
    arg = event.pattern_match.group(1).strip()

    file_path = "YamenThon.log"
    if not arg: 
        with open(file_path, "r") as file:
            content = file.read()[-4000:]
        return await event.eor(f"`{content}`")
    elif arg == "ØªÙ„Ø¬Ø±Ø§Ù":
        client = get_client()
        with open(file_path, "r") as file:
            title = "YamenThon Logs"
            page = client.create_page(title=title, content=[file.read()])
        await event.eor(f'[YamenThon Logs]({page["url"]})', link_preview=True)
    await event.eor(file=file_path)


@jmthon_cmd(pattern="Ø§Ø¹Ø§Ø¯Ø© ØªØ´ØºÙŠÙ„$")
async def restart_jmthon(event):
    restart_steps = [
        {"percent": 10, "message": "**âˆ Ø¬Ù€Ø§Ø±ÙŠ Ø¥Ø¹Ù€Ø§Ø¯Ø© ØªØ´ØºÙŠÙ€Ù„ Ø§Ù„Ø³Ù€ÙˆØ±Ø³.. âğŸŒâ **", "bar": "â–°â–±â–±â–±â–±â–±â–±â–±â–±"},
        {"percent": 20, "message": "**âˆ Ø¬Ù€Ø§Ø±ÙŠ Ø¥ØºÙ„Ù€Ø§Ù‚ Ø§Ù„Ø§ØªØµÙ€Ø§Ù„Ø§Øª.. âğŸ“¡â **", "bar": "â–°â–°â–±â–±â–±â–±â–±â–±â–±"},
        {"percent": 30, "message": "**âˆ Ø¬Ù€Ø§Ø±ÙŠ Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª.. âğŸ’¾**â ", "bar": "â–°â–°â–°â–±â–±â–±â–±â–±â–±"},
        {"percent": 40, "message": "**âˆ Ø¬Ù€Ø§Ø±ÙŠ Ø¥ÙŠÙ‚Ù€Ø§Ù Ø§Ù„ÙˆØ­Ù€Ø¯Ø§Øª.. ââš™ï¸â **", "bar": "â–°â–°â–°â–°â–±â–±â–±â–±â–±"},
        {"percent": 50, "message": "**âˆ Ø¬Ù€Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ€Ù„ Ø§Ù„Ù…Ù„ÙÙ€Ø§Øª.. âğŸ“‚**â ", "bar": "â–°â–°â–°â–°â–°â–±â–±â–±â–±"},
        {"percent": 60, "message": "**âˆ Ø¬Ù€Ø§Ø±ÙŠ ØªÙ‡ÙŠØ¦Ù€Ø© Ø§Ù„Ù†Ø¸Ù€Ø§Ù….. âğŸ”§â **", "bar": "â–°â–°â–°â–°â–°â–°â–±â–±â–±"},
        {"percent": 70, "message": "**âˆ Ø¬Ù€Ø§Ø±ÙŠ ØªØ´ØºÙŠÙ€Ù„ Ø§Ù„Ø®Ø¯Ù…Ù€Ø§Øª.. âğŸ› ï¸**â ", "bar": "â–°â–°â–°â–°â–°â–°â–°â–±â–±"},
        {"percent": 80, "message": "**âˆ Ø¬Ù€Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù‚Ù€Ù‚ Ù…Ù† Ø§Ù„Ù‚Ù€ÙˆØ§Ø¹Ø¯.. âğŸ“Š**â ", "bar": "â–°â–°â–°â–°â–°â–°â–°â–°â–±"},
        {"percent": 90, "message": "**âˆ Ø¬Ù€Ø§Ø±ÙŠ ØªÙ†Ø´Ù€ÙŠØ· Ø§Ù„Ù†Ø¸Ù€Ø§Ù….. ââš¡**â ", "bar": "â–°â–°â–°â–°â–°â–°â–°â–°â–°"},
        {"percent": 100, "message": "**âˆ ØªÙ…Ù€Øª Ø§Ù„Ø¹Ù…Ù„ÙŠÙ€Ø© Ø¨Ù†Ø¬Ù€Ø§Ø­! ââœ…â **", "bar": "â–°â–°â–°â–°â–°â–°â–°â–°â–°"}
    ]

    msg = await event.eor("**âˆ Ø¨Ø¯Ø¡ Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ´ØºÙŠÙ„.. âğŸŒ€â **")
    
    for step in restart_steps:
        progress_text = (
            f"ğ“†© [ğ™ğ™Šğ™ğ™ğ˜¾ğ ğ™”ğ˜¼ğ™ˆğ™€ğ™‰ğ™ğ™ƒğ™Šğ™‰](t.me/YamenThon) ğ“†ª\n"
            f"**{step['message']}**\n\n"
            f"â” **Ø§Ù„ØªÙ‚Ø¯Ù…:** {step['percent']}%\n"
            f"â” **Ø§Ù„Ø­Ø§Ù„Ø©:** `{step['bar']}`\n\n"
            f"**âˆ Ø§Ù„Ø±Ø¬Ù€Ø§Ø¡ Ø§Ù„Ø§Ù†ØªØ¸Ù€Ø§Ø±..** ââ³â "
        )
        await msg.edit(progress_text)
        await asyncio.sleep(0.8)  # Ø²Ù…Ù† Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø± Ø¨ÙŠÙ† ÙƒÙ„ Ø®Ø·ÙˆØ©

    # Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ø¥ÙƒÙ…Ø§Ù„ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©
    success_msg = (
        f"ğ“†© [ğ™ğ™Šğ™ğ™ğ˜¾ğ ğ™”ğ˜¼ğ™ˆğ™€ğ™‰ğ™ğ™ƒğ™Šğ™‰](t.me/YamenThon) ğ“†ª\n\n"
        f"**âˆ ØªÙ… Ø¥Ø¹Ù€Ø§Ø¯Ø© ØªØ´ØºÙŠÙ€Ù„ Ø§Ù„Ø³Ù€ÙˆØ±Ø³ Ø¨Ù†Ø¬Ù€Ø§Ø­! âğŸ‰â **\n\n"
        f"â” **Ø§Ù„Ø­Ø§Ù„Ø©:** `âœ… ØªÙ… Ø§Ù„ØªÙ†ÙÙŠØ° Ø¨Ù†Ø¬Ø§Ø­`\n"
        f"â” **Ø§Ù„ÙˆÙ‚Øª:** `{time.strftime('%H:%M:%S')}`\n\n"
        f"**âˆ ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„Ø¢Ù† Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø³ÙˆØ±Ø³ Ø¨Ø´ÙƒÙ„ Ø·Ø¨ÙŠØ¹ÙŠ** ââœ¨â "
    )
    
    await msg.edit(success_msg)
    await asyncio.sleep(3)  # Ø¹Ø±Ø¶ Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ù†Ø¬Ø§Ø­ Ù„Ù…Ø¯Ø© 3 Ø«ÙˆØ§Ù†ÙŠ
    
    # Ø§Ù„ØªÙ†ÙÙŠØ° Ø§Ù„ÙØ¹Ù„ÙŠ Ù„Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ´ØºÙŠÙ„
    os.execl(sys.executable, sys.executable, "-m", "yamenthon")

@jmthon_cmd(pattern="ØªØ­Ø¯ÙŠØ«( (.*)|$)")
async def update_jmthon(e):
    xx = await e.eor("**âŒ”âˆ® Ø¬Ø§Ø± Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† ØªØ­Ø¯ÙŠØ«Ø§Øª Ù„Ø³ÙˆØ±Ø³ ÙŠÙ€Ù€Ù€Ù…Ù†Ø«ÙˆÙ†**")
    cmd = e.pattern_match.group(1).strip()
    
    if cmd and ("Ø³Ø±ÙŠØ¹" in cmd or "Ø®ÙÙŠÙ" in cmd):
        await bash("git pull -f")
        await xx.edit("**âŒ”âˆ® Ø¬Ø§Ø± Ø§Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø®ÙÙŠÙ ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø£Ù†ØªØ¸Ø§Ø±**")
        os.execl(sys.executable, sys.executable, "-m", "yamenthon")
        return

    # Ø¥Ø¸Ù‡Ø§Ø± Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„ØªÙ‚Ø¯Ù…
    await xx.edit("**âŒ”âˆ® Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ØªØ­Ø¯ÙŠØ«Ø§Øª...**")
    await asyncio.sleep(1)
    
    remote_url = repo.get_remote_url()
    if remote_url.endswith(".git"):
        remote_url = remote_url[:-4]
    
    m = check_update()
    if not m:
        return await xx.edit(
            f'<strong>Ø³ÙˆØ±Ø³ ÙŠÙ€Ù€Ù€Ù…Ù†Ø«ÙˆÙ† Ù…ÙØ­Ø¯Ø« Ø¨Ø£Ø®Ø± Ø£ØµØ¯Ø§Ø±</strong>',
            parse_mode="html",
            link_preview=False,
        )

    # Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„ØªÙ‚Ø¯Ù… Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ØªØ­Ø¯ÙŠØ«
    steps = [
        (10, "**âŒ”âˆ® Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªØ­Ø¯ÙŠØ«Ø§Øª...ğŸŒ**\n\n%ğŸ·ğŸ¶ â–¬â–­â–­â–­â–­â–­â–­â–­â–­â–­"),
        (20, "**âŒ”âˆ® Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªØ­Ø¯ÙŠØ«Ø§Øª...ğŸŒ**\n\n%ğŸ¸ğŸ¶ â–¬â–¬â–­â–­â–­â–­â–­â–­â–­â–­"),
        (30, "**âŒ”âˆ® Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªØ­Ø¯ÙŠØ«Ø§Øª...ğŸŒ**\n\n%ğŸ¹ğŸ¶ â–¬â–¬â–¬â–­â–­â–­â–­â–­â–­â–­"),
        (40, "**âŒ”âˆ® Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªØ­Ø¯ÙŠØ«Ø§Øª...ğŸŒ**\n\n%ğŸºğŸ¶ â–¬â–¬â–¬â–¬â–­â–­â–­â–­â–­â–­"),
        (50, "**âŒ”âˆ® Ø¬Ø§Ø±ÙŠ ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ØªØ­Ø¯ÙŠØ«Ø§Øª...ğŸŒ**\n\n%ğŸ»ğŸ¶ â–¬â–¬â–¬â–¬â–¬â–­â–­â–­â–­â–­"),
        (60, "**âŒ”âˆ® Ø¬Ø§Ø±ÙŠ ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ØªØ­Ø¯ÙŠØ«Ø§Øª...ğŸŒ**\n\n%ğŸ¼ğŸ¶ â–¬â–¬â–¬â–¬â–¬â–¬â–­â–­â–­â–­"),
        (70, "**âŒ”âˆ® Ø¬Ø§Ø±ÙŠ ØªØ«Ø¨ÙŠØª Ø§Ù„Ù…ØªØ·Ù„Ø¨Ø§Øª...ğŸŒ**\n\n%ğŸ½ğŸ¶ â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–­â–­â–­"),
        (80, "**âŒ”âˆ® Ø¬Ø§Ø±ÙŠ ØªØ«Ø¨ÙŠØª Ø§Ù„Ù…ØªØ·Ù„Ø¨Ø§Øª...ğŸŒ**\n\n%ğŸ¾ğŸ¶ â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–­â–­"),
        (90, "**âŒ”âˆ® Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡ Ù…Ù† Ø§Ù„ØªØ­Ø¯ÙŠØ«...ğŸŒ**\n\n%ğŸ¿ğŸ¶ â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–­"),
        (100, "**âŒ”âˆ® ØªÙ… Ø§Ù„ØªØ­Ø¯ÙŠØ« Ø¨Ù†Ø¬Ø§Ø­! Ø¬Ø§Ø±ÙŠ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ´ØºÙŠÙ„...ğŸ”„**\n\n%ğŸ·ğŸ¶ğŸ¶ â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬ğŸ’¯")
    ]

    for percent, message in steps:
        await xx.edit(message)
        await asyncio.sleep(1)

    await update(xx)


async def update(eve):
    await bash(f"git pull && {sys.executable} -m pip install -r requirements.txt")
    await eve.edit("âœ… <strong>ØªÙ… Ø§Ù„ØªØ­Ø¯ÙŠØ« Ø¨Ù†Ø¬Ø§Ø­.</strong>", parse_mode="html")
    os.execl(sys.executable, sys.executable, "-m", "yamenthon")
